#!/usr/local/bin/php
<?php
namespace Retriever\Application;

use Retriever\Infrastructure\Persistence\SQLiteWorkRequestRepository;

require_once __DIR__ . '/../../vendor/autoload.php';

$databaseFile = __DIR__.'/../../data/retriever.sqlite';
$repository = new SQLiteWorkRequestRepository($databaseFile);
$scheduler = new Scheduler($repository);

while ($scheduler->remainingRequestsExist())
{
    $request = $scheduler->retrieveScheduledRequest();
    $process_call = __DIR__."/retriever-executeRequest {$request->document()} --destination {$request->destination()}";

    $process = proc_open(
        $process_call,
        [
            0 => ['pipe', 'r'],
            1 => ['file', '/tmp/retriever-executeRequest.log', 'a'],
            2 => ['file', '/tmp/retriever-executeRequest-error.log', 'a']
        ],
        $pipes
    );

    if (is_resource($process) === false) {
        exit(1);
    }

    fclose($pipes[0]);
    
    $successful = proc_close($process);
    if ($successful !== 0) {
        exit($successful);
    }

    $scheduler->acknowledgeRequest($request);
}
